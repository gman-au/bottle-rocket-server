@using System.Security.Claims
@using System.Threading
@using Microsoft.Extensions.Options
@using Rocket.Domain.Core.Enum
@using Rocket.Domain.Core.Utils
@using Rocket.Interfaces
@using Rocket.Web.Client
@using Rocket.Web.Client.Options
@using Rocket.Web.Host.Components.Dialog
@inject NavigationManager NavigationManager
@inject IAuthenticationManager AuthenticationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IApiRequestManager ApiRequestManager
@inject IDialogService DialogService
@inject IOptions<SiteConfigurationOptions> SiteConfigurationOptions

<MudAppBar Elevation="1">
    <MudIconButton Icon="@Icons.Material.Filled.Menu" Edge="Edge.Start" OnClick="@ToggleDrawer"/>
    <MudSpacer/>
    <MudIconButton Icon="@Icons.Custom.Brands.GitHub" Href="https://github.com/gman-au/bottle-rocket-server" Target="_blank"/>
</MudAppBar>
<MudDrawer @bind-Open="@_open" Elevation="1">
    <MudDrawerHeader>
        <MudGrid>
            <MudItem xs="12">
                <MudContainer Class="logo-circle">
                    <MudLink Color="Color.Inherit" Href="/">
                        <MudImage Class="logo-circle-svg" Src="@Assets["img/bottle-rocket-logo.svg"]"/>
                    </MudLink>
                </MudContainer>
            </MudItem>
            <MudItem xs="12">
                <MudText Align="Align.Center" Typo="Typo.h5">Bottle Rocket</MudText>
            </MudItem>
            @if (_isInitialized && !string.IsNullOrEmpty(_userName))
            {
                <MudItem Class="py-2" xs="12">
                    <MudText
                        Align="Align.Center"
                        Typo="Typo.body2"
                        Color="Color.Secondary"
                    >
                        @_userName
                    </MudText>
                </MudItem>
            }
        </MudGrid>
    </MudDrawerHeader>
    <MudNavMenu Dense Bordered="true" Color="Color.Primary">
        @if (_isInitialized)
        {
            <AuthorizeView Context="primary">
                <Authorized>
                    <MudNavLink
                        Match="NavLinkMatch.All"
                        Href="/"
                        Icon="@StandardIcons.DashboardIcon"
                    >
                        Home
                    </MudNavLink>
                    @if (_isRootAdmin && _isSetupPending)
                    {
                        <MudNavLink
                            Match="NavLinkMatch.All"
                            Href="/CompleteSetup"
                            Icon="@StandardIcons.CompleteSetupIcon"
                        >
                            Complete setup
                        </MudNavLink>
                    }
                    else
                    {
                        if (_isAdmin)
                        {
                            <MudNavGroup
                                Title="Users"
                                Icon="@StandardIcons.UsersIcon"
                                Expanded="true"
                            >
                                <MudNavLink
                                    Match="NavLinkMatch.Prefix"
                                    Href="/Users"
                                    Icon="@StandardIcons.SearchUserIcon"
                                >
                                    Manage users
                                </MudNavLink>
                                <MudNavLink
                                    Match="NavLinkMatch.Prefix"
                                    Href="/Users/Add"
                                    Icon="@StandardIcons.AddUserIcon"
                                >
                                    Add user
                                </MudNavLink>
                            </MudNavGroup>
                        }

                        <MudNavLink
                            Match="NavLinkMatch.Prefix"
                            Href="/MyScans"
                            Icon="@StandardIcons.ScansIcon"
                        >
                            My scans
                        </MudNavLink>
                        <MudNavGroup
                            Title="My connectors"
                            Icon="@StandardIcons.ConnectorsIcon"
                            Expanded="true"
                        >
                            <MudNavLink
                                Match="NavLinkMatch.All"
                                Href="/MyConnectors"
                                Icon="@StandardIcons.SearchConnectorIcon"
                            >
                                Manage my connectors
                            </MudNavLink>
                            <MudNavLink
                                Match="NavLinkMatch.Prefix"
                                Href="/MyConnectors/Add"
                                Icon="@StandardIcons.AddConnectorIcon"
                            >
                                Add connector
                            </MudNavLink>
                        </MudNavGroup>
                        <MudNavGroup
                            Title="My workflows"
                            Icon="@StandardIcons.WorkflowsIcon"
                            Expanded="true"
                        >
                            <MudNavLink
                                Match="NavLinkMatch.All"
                                Href="/MyWorkflows"
                                Icon="@StandardIcons.SearchWorkflowIcon"
                            >
                                Manage my workflows
                            </MudNavLink>
                            <MudNavLink
                                Match="NavLinkMatch.Prefix"
                                Href="/MyWorkflows/Add"
                                Icon="@StandardIcons.AddWorkflowIcon"
                            >
                                Add workflow
                            </MudNavLink>
                        </MudNavGroup>
                        <MudNavLink
                            Match="NavLinkMatch.All"
                            OnClick="ConfirmLogoutAsync"
                            Icon="@StandardIcons.LogoutIcon"
                        >
                            Logout
                        </MudNavLink>
                    }
                </Authorized>
                <NotAuthorized>
                    <MudNavLink
                        Match="NavLinkMatch.All"
                        Href="/Account/Login"
                        Icon="@StandardIcons.LoginIcon"
                    >
                        Login
                    </MudNavLink>
                </NotAuthorized>
            </AuthorizeView>
            <MudNavLink
                Icon="@(DarkMode ? Icons.Material.Filled.WbSunny : Icons.Material.Filled.ModeNight)"
                OnClick="@OnDarkModeToggle"
            >
                @(DarkMode ? "Switch to light mode" : "Switch to dark mode")
            </MudNavLink>
            if (!string.IsNullOrEmpty(SiteConfigurationOptions?.Value?.DocumentationUrl))
            {
                <MudNavLink
                    Href="@SiteConfigurationOptions?.Value?.DocumentationUrl"
                    Icon="@StandardIcons.HelpIcon"
                    ForceLoad="true"
                    Target="_blank"
                >
                    Help
                </MudNavLink>
            }
        }
    </MudNavMenu>
    <MudSpacer/>
    <BottleRocketVersion/>
</MudDrawer>

@code {

    private bool _isRootAdmin;

    private bool _isAdmin = false;

    private bool _isSetupPending;

    private bool _open = true;

    private bool _isInitialized = false;

    private string _userName = null;

    private string _userRole = null;

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to auth changes
        AuthenticationManager.OnAuthenticationStateChanged += HandleAuthStateChanged;

        // Wait for auth check to complete (this triggers EnsureInitializedAsync)
        await
            AuthenticationManager
                .IsAuthenticatedAsync();

        await
            LoadUserNameAndRole();

        await
            CheckAdminSetupStatus();

        // Now we know auth state is determined
        _isInitialized = true;
    }

    private async void HandleAuthStateChanged()
    {
        await InvokeAsync(
            async () =>
            {
                await
                    LoadUserNameAndRole();

                await
                    CheckAdminSetupStatus();

                StateHasChanged();
            }
        );
    }

    private async Task CheckAdminSetupStatus()
    {
        _isRootAdmin =
            await
                AuthenticationManager
                    .IsRootAdminAsync();

        if (_isRootAdmin)
        {
            var phaseResponse =
                await
                    ApiRequestManager
                        .GetStartupPhaseAsync(CancellationToken.None);

            _isSetupPending = phaseResponse.Phase == (int)StartupPhaseEnum.AdminPendingDeactivation;
        }
        else
        {
            _isSetupPending = false;
        }
    }

    private async Task LoadUserNameAndRole()
    {
        var authState =
            await
                AuthenticationStateProvider
                    .GetAuthenticationStateAsync();

        var user =
            authState
                .User;

        if (user.Identity?.IsAuthenticated == true)
        {
            _userName =
                user
                    .FindFirst(ClaimTypes.Name)?.Value ?? "User";

            _userRole =
                user
                    .FindFirst(ClaimTypes.Role)?.Value ?? string.Empty;
        }
        else
        {
            _userName = null;
            _userRole = null;
        }

        _isAdmin = _userRole == DomainConstants.AdminRole;
    }

    private void ToggleDrawer()
    {
        _open = !_open;
    }

    private readonly MudTheme _theme = BottleRocketMudThemeProvider.MyTheme;

    [Parameter]
    public bool DarkMode { get; set; }

    [Parameter]
    public EventCallback<MouseEventArgs> OnDarkModeToggle { get; set; }

    private async Task ConfirmLogoutAsync()
    {
        var dialog =
            await
                DialogService
                    .ShowAsync<ConfirmLogoutDialog>();

        var result =
            await
                dialog
                    .Result;

        if (!(result?.Canceled ?? true))
        {
            NavigationManager
                .NavigateTo(
                    "/Account/Logout",
                    forceLoad: true
                );
        }
    }

    public void Dispose()
    {
        AuthenticationManager.OnAuthenticationStateChanged -= HandleAuthStateChanged;
    }

}