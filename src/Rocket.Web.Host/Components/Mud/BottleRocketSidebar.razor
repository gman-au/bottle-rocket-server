@using Microsoft.Extensions.Options
@using Rocket.Interfaces
@using Rocket.Web.Host.Components.Dialog
@using Rocket.Web.Host.Options
@inject NavigationManager NavigationManager
@inject IAuthenticationManager AuthenticationManager
@inject IDialogService DialogService
@inject IOptions<SiteConfigurationOptions> SiteConfigurationOptions

<MudAppBar Elevation="1">
    <MudIconButton Icon="@Icons.Material.Filled.Menu" Edge="Edge.Start" OnClick="@ToggleDrawer"/>
    <MudSpacer/>
    <MudIconButton Icon="@Icons.Custom.Brands.GitHub" Href="https://github.com/gman-au/bottle-rocket-server" Target="_blank"/>
</MudAppBar>
<MudDrawer @bind-Open="@_open" Elevation="1">
    <MudDrawerHeader>
        <MudGrid>
            <MudItem xs="12">
                <MudContainer Class="logo-circle">
                    <MudLink Color="Color.Inherit" Href="/">
                        <MudImage Class="logo-circle-svg" Src="@Assets["img/bottle-rocket-logo.svg"]"/>
                    </MudLink>
                </MudContainer>
            </MudItem>
            <MudItem xs="12">
                <MudText Align="Align.Center" Typo="Typo.h5">Bottle Rocket</MudText>
            </MudItem>
        </MudGrid>
    </MudDrawerHeader>
    <MudNavMenu Bordered="true" Color="Color.Primary">
        @if (_isInitialized)
        {
            <AuthorizeView Context="primary">
                <Authorized>
                    <MudNavLink Match="NavLinkMatch.All" Href="/" Icon="@StandardIcons.DashboardIcon">Home</MudNavLink>
                    @* <MudNavLink Match="NavLinkMatch.All" Href="/MyAccount" Icon="@StandardIcons.AccountIcon">Account</MudNavLink> *@
                    <MudNavLink Match="NavLinkMatch.Prefix" Href="/MyScans" Icon="@StandardIcons.ScansIcon">My Scans</MudNavLink>
                    <MudNavLink Match="NavLinkMatch.All" OnClick="ConfirmLogoutAsync" Icon="@StandardIcons.LogoutIcon">Logout</MudNavLink>
                </Authorized>
                <NotAuthorized>
                    <MudNavLink Match="NavLinkMatch.All" Href="/Account/Login" Icon="@StandardIcons.LoginIcon">Login</MudNavLink>
                </NotAuthorized>
            </AuthorizeView>
            <MudNavLink Icon="@(DarkMode ? Icons.Material.Filled.WbSunny : Icons.Material.Filled.ModeNight)" OnClick="@OnDarkModeToggle">
                @(DarkMode ? "Switch to light mode" : "Switch to dark mode")
            </MudNavLink>
            if (!string.IsNullOrEmpty(SiteConfigurationOptions?.Value?.DocumentationUrl))
            {
                <MudNavLink Href="@SiteConfigurationOptions?.Value?.DocumentationUrl" Icon="@StandardIcons.HelpIcon" ForceLoad="true" Target="_blank">
                    Help
                </MudNavLink>
            }
        }
    </MudNavMenu>
    <MudSpacer/>
    <BottleRocketVersion/>
</MudDrawer>

@code {

    private bool _open = true;

    private bool _isInitialized = false;

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to auth changes
        AuthenticationManager.OnAuthenticationStateChanged += HandleAuthStateChanged;
        
        // Wait for auth check to complete (this triggers EnsureInitializedAsync)
        await 
            AuthenticationManager
                .IsAuthenticatedAsync();
        
        // Now we know auth state is determined
        _isInitialized = true;
    }

    private async void HandleAuthStateChanged()
    {
        await 
            InvokeAsync(StateHasChanged);
    }

    private void ToggleDrawer()
    {
        _open = !_open;
    }

    private readonly MudTheme _theme = BottleRocketMudThemeProvider.MyTheme;

    [Parameter]
    public bool DarkMode { get; set; }

    [Parameter]
    public EventCallback<MouseEventArgs> OnDarkModeToggle { get; set; }

    private async Task ConfirmLogoutAsync()
    {
        var dialog =
            await
                DialogService
                    .ShowAsync<ConfirmLogoutDialog>();

        var result =
            await
                dialog
                    .Result;

        if (!(result?.Canceled ?? true))
        {
            NavigationManager
                .NavigateTo(
                    "/Account/Logout",
                    forceLoad: true
                );
        }
    }

    public void Dispose()
    {
        AuthenticationManager.OnAuthenticationStateChanged -= HandleAuthStateChanged;
    }

}