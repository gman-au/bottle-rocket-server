@page "/User/{id}"
@using Rocket.Api.Contracts
@using Rocket.Interfaces
@using Rocket.Web.Host.Api
@using Rocket.Web.Host.Components.Dialog
@using Rocket.Web.Host.Infrastructure
@inject IApiRequestManager ApiRequestManager
@inject IEmailAddressValidator EmailAddressValidator
@inject IWebHostErrorHandler WebHostErrorHandler
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inherits Rocket.Web.Host.Infrastructure.BaseSecureCancellableComponent

<BottleRocketLoadingOverlay IsLoading="@_isLoading">
    @if (_newModel != null)
    {
        <MudForm
            Model="@_newModel"
            @ref="_form">
            <MudPaper Class="p-4" elevation="2">
                <MudText
                    Align="Align.Center"
                    Typo="Typo.h4"
                    Color="Color.Primary"
                    Class="mb-4">
                    User Details
                </MudText>

                <MudGrid>
                    <MudItem sm="12" lg="6" xl="4">
                        <MudTextField
                            T="string"
                            Label="Date Created"
                            ReadOnly
                            Disabled
                            Text="@(_newModel.CreatedAt?.ToString("g"))"
                            OnlyValidateIfDirty/>
                    </MudItem>
                    <MudItem sm="12" lg="6" xl="4">
                        <MudTextField
                            T="string"
                            Label="Last Login"
                            ReadOnly
                            Disabled
                            Text="@(_newModel.LastLoginAt?.ToString("g"))"
                            OnlyValidateIfDirty/>
                    </MudItem>
                    <MudFlexBreak/>
                    <MudItem sm="12" lg="6" xl="4">
                        <MudTextField
                            T="string"
                            Label="Username"
                            Required="true"
                            Validation="@(new Func<string, bool>(EmailAddressValidator.IsValid))"
                            RequiredError="Please enter a valid email address"
                            Disabled="@(_isLoading)"
                            @bind-Value="_newModel.Username"
                            For="@(() => _newModel.Username)"
                            OnlyValidateIfDirty/>
                    </MudItem>
                    <MudItem sm="12" lg="6" xl="4">
                        <MudTextField
                            T="string"
                            Label="Password"
                            HelperText="Choose a strong password"
                            @ref="_pwField1"
                            InputType="InputType.Password"
                            @bind-Value="_newModel.NewPassword"
                            For="@(() => _newModel.NewPassword)"
                            Validation="@(new Func<string, IEnumerable<string>>(PasswordValidation.PasswordStrength))"
                            RequiredError="Password is required!"/>
                    </MudItem>
                    <MudItem sm="12" lg="6" xl="4">
                        <MudTextField
                            T="string"
                            Label="Password"
                            HelperText="Repeat the password"
                            InputType="InputType.Password"
                            Validation="@(new Func<string, string>(PasswordMatch))"/>
                    </MudItem>
                    <MudFlexBreak/>
                    <MudItem sm="12" lg="6" xl="4">
                        <MudCheckBox
                            TriState
                            Disabled="@(_isLoading)"
                            @bind-Value="@_newModel.IsActive">
                            This user is active
                        </MudCheckBox>
                    </MudItem>
                    <MudItem sm="12" lg="6" xl="4">
                        <MudCheckBox
                            TriState
                            Disabled="@(_isLoading)"
                            @bind-Value="@_newModel.IsAdmin">
                            This user is the administrator
                        </MudCheckBox>
                    </MudItem>
                </MudGrid>
                <MudGrid Class="align-start" Justify="Justify.FlexEnd">
                    <MudItem>
                        <GoBackButton BackPath="/Users"/>
                    </MudItem>
                    <MudItem>
                        <MudButton
                            Variant="Variant.Outlined"
                            Color="Color.Success"
                            Disabled="@(_isLoading)"
                            OnClick="@SubmitAsync">
                            Submit
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudForm>
    }
</BottleRocketLoadingOverlay>

@code {

    MudForm _form;

    private bool _isLoading;
    private UserDetail _currentModel = null;
    private UserDetail _newModel = null;
    private MudTextField<string> _pwField1;

    [Parameter]
    public string Id { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await
                base
                    .OnInitializedAsync();

            _isLoading = true;
            StateHasChanged();

            _currentModel =
                await
                    ApiRequestManager
                        .GetUserByIdAsync(
                            Id,
                            BaseCancellationToken
                        );

            _newModel = new UserDetail
            {
                Id = _currentModel.Id,
                Username = _currentModel.Username,
                IsActive = _currentModel.IsActive,
                IsAdmin = _currentModel.IsAdmin,
                LastLoginAt = _currentModel.LastLoginAt,
                CreatedAt = _currentModel.CreatedAt,
                NewPassword = null
            };
        }
        catch (Exception ex)
        {
            WebHostErrorHandler
                .HandleException(ex);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task ConfirmAdminRevocationAsync()
    {
        var dialog =
            await
                DialogService
                    .ShowAsync<ConfirmRevokeAdminDialog>();

        var result =
            await
                dialog
                    .Result;

        if (!(result?.Canceled ?? true))
        {
            await
                SubmitAsync();
        }
    }

    private async Task SubmitAsync()
    {
        await
            _form
                .Validate();

        if (_form.IsValid)
        {
            var revokingAdmin = _currentModel.IsAdmin != true && _newModel.IsAdmin == true;

            if (revokingAdmin)
            {
                var dialog =
                    await
                        DialogService
                            .ShowAsync<ConfirmRevokeAdminDialog>();

                var result =
                    await
                        dialog
                            .Result;

                if (result?.Canceled == true)
                    return;
            }

            _isLoading = true;
            StateHasChanged();

            try
            {
                var userNameValue = _currentModel.Username != _newModel.Username ? _newModel.Username : null;
                var isActiveValue = _currentModel.IsActive != _newModel.IsActive ? _newModel.IsActive : null;
                var isAdminValue = _currentModel.IsAdmin != _newModel.IsAdmin ? _newModel.IsAdmin : null;
                var newPasswordValue = _currentModel.NewPassword != _newModel.NewPassword ? _newModel.NewPassword : null;

                await
                    ApiRequestManager
                        .UpdateUserAsync(
                            new UserDetail
                            {
                                Id = _newModel.Id,
                                Username = _currentModel.Username != _newModel.Username ? _newModel.Username : null,
                                IsActive = _currentModel.IsActive != _newModel.IsActive ? _newModel.IsActive : null,
                                IsAdmin = _currentModel.IsAdmin != _newModel.IsAdmin ? _newModel.IsAdmin : null,
                                NewPassword = _currentModel.NewPassword != _newModel.NewPassword ? _newModel.NewPassword : null
                            },
                            BaseCancellationToken
                        );

                _currentModel = new UserDetail
                {
                    Id = _currentModel.Id,
                    Username = userNameValue ?? _currentModel.Username,
                    IsActive = isActiveValue ?? _currentModel.IsActive,
                    IsAdmin = isAdminValue ?? _currentModel.IsAdmin,
                    LastLoginAt = _currentModel.LastLoginAt,
                    CreatedAt = _currentModel.CreatedAt,
                    NewPassword = null
                };

                Snackbar
                    .Add(
                        "The user has been updated.",
                        Severity.Success
                    );

                if (revokingAdmin)
                {
                    NavigationManager
                        .NavigateTo("Account/Logout");
                }
            }
            catch (Exception ex)
            {
                WebHostErrorHandler
                    .HandleException(ex);
            }
            finally
            {
                _isLoading = false;
                StateHasChanged();
            }
        }
    }

    private string PasswordMatch(string arg)
    {
        if (_pwField1.Value != arg)
            return "Passwords don't match";
        return null;
    }

}