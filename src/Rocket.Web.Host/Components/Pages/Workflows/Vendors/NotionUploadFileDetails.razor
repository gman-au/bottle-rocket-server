@page "/MyWorkflow/Notion/{workflowId}/AddStep"
@page "/MyWorkflow/Notion/{workflowId}/Steps/{parentStepId}/AddStep"
@page "/MyWorkflow/Notion/{workflowId}/Steps/{stepId}/UpdateStep"
@using Rocket.Notion.Contracts
@using Rocket.Notion.Domain
@using Rocket.Web.Host.Infrastructure
@inject IWebHostErrorHandler WebHostErrorHandler

@using Rocket.Web.Client
@inject IApiRequestManager ApiRequestManager
@inherits Rocket.Web.Host.Infrastructure.BaseSecureCancellableComponent

<BottleRocketLoadingOverlay IsLoading="@_isLoading">
    <UpdateWorkflowStepWrapper
        @ref="_wrapper"
        T="NotionUploadWorkflowStepSpecifics"
        WorkflowStepName="Upload file to Notion"
        WorkflowId="@WorkflowId"
        ParentStepId="@ParentStepId"
        RequiresConnectorCode="@NotionDomainConstants.ConnectorCode"
        OnConnectorIdChanged="ConnectorChangedAsync"
        StepId="@StepId"
        Context="stepSpecifics">
        <MudGrid>
            <MudItem sm="12" lg="6">
                <MudSelect
                    T="NotionParentNoteSummary"
                    Label=@(_isLoading ? "Loading..." : "Select a parent note")
                    @bind-Value="@_parentNoteSelected"
                    @bind-Value:after="() => ParentNoteChangedAsync(stepSpecifics)"
                    Disabled="@_isLoading"
                    Clearable
                    Required
                    RequiredError="Parent note is required">
                    @foreach (var parentNote in _parentNotes ?? [])
                    {
                        <MudSelectItem
                            T="NotionParentNoteSummary"
                            Value="@parentNote"
                        >
                            @parentNote.ParentNoteName
                        </MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
        </MudGrid>
    </UpdateWorkflowStepWrapper>
</BottleRocketLoadingOverlay>

@code {

    [Parameter]
    public string WorkflowId { get; set; }

    [Parameter]
    public string ParentStepId { get; set; }

    [Parameter]
    public string StepId { get; set; }

    private bool _isLoading;

    private string _connectorId;

    private UpdateWorkflowStepWrapper<NotionUploadWorkflowStepSpecifics> _wrapper;

    private NotionParentNoteSummary _parentNoteSelected;

    private IEnumerable<NotionParentNoteSummary> _parentNotes = [];

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await
                base
                    .OnInitializedAsync();

            _isLoading = true;
            StateHasChanged();

            await
                RefreshParentNotesAsync();
        }
        catch (Exception ex)
        {
            WebHostErrorHandler
                .HandleException(ex);
        }

        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task RefreshParentNotesAsync()
    {
        try
        {
            if (!string.IsNullOrEmpty(_connectorId))
            {
                _isLoading = true;
                StateHasChanged();
                
                var response =
                    await
                        ApiRequestManager
                            .GetNotionParentNotesAsync(
                                new GetAllNotionParentNotesRequest
                                {
                                    ConnectorId = _connectorId
                                },
                                BaseCancellationToken
                            );

                _parentNotes =
                    response?
                        .ParentNotes ?? [];

                _parentNoteSelected =
                    _parentNotes
                        .FirstOrDefault(o => _wrapper?.StepSpecifics?.ParentNoteId == o.ParentNoteId);
            }
            else
            {
                _parentNotes = [];
            }
        }
        catch (Exception ex)
        {
            WebHostErrorHandler
                .HandleException(ex);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }

        StateHasChanged();
    }

    private async Task ParentNoteChangedAsync(NotionUploadWorkflowStepSpecifics stepSpecifics)
    {
        stepSpecifics.ParentNoteId =
            _parentNoteSelected?
                .ParentNoteId;
    }

    private async Task ConnectorChangedAsync(string connectorId)
    {
        _connectorId = connectorId;

        if (string.IsNullOrEmpty(connectorId))
        {
            _parentNoteSelected = null;
        }

        await
            RefreshParentNotesAsync();
    }

}