@page "/MyScans"
@using Rocket.Api.Contracts
@using Rocket.Web.Host.Api
@using Rocket.Web.Host.HubClients
@implements IAsyncDisposable
@inject IApiRequestManager ApiRequestManager
@inject ISnackbar Snackbar
@inject ICaptureHubClient CaptureHubClient
@inherits Rocket.Web.Host.Infrastructure.CancellableComponentBase

<MudPaper Class="p-4" elevation="2">
    <MudText Typo="Typo.h4">
        My Scans
        @if (_isConnected)
        {
            <MudChip Color="Color.Success" Size="Size.Small" Class="ml-2">
                <MudIcon Icon="@Icons.Material.Filled.Wifi" Size="Size.Small"/>
                Connected
            </MudChip>
        }
    </MudText>
    <BottleRocketLoadingOverlay IsLoading="@_isLoading">
        <MudGrid Class="pa-4">
            @foreach (var scan in _scans)
            {
                <MudItem xs="12" sm="6" md="4" lg="3" xl="2">
                    <MudCard Outlined>
                        <MudCardMedia
                            Image=@($"data:{scan.ContentType};base64,{scan.ThumbnailBase64}") Width="200" Height="200"/>
                        <MudCardContent>
                            <MudText Typo="Typo.body1">@(scan.DateScanned.ToString("g"))</MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    </BottleRocketLoadingOverlay>
</MudPaper>

@code {
    private bool _isLoading;
    private bool _isConnected;
    private IEnumerable<Scan> _scans = [];

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _isLoading = true;

            // Set up SignalR listener
            CaptureHubClient.OnNewCaptureReceived += HandleNewCapture;

            // Connect to hub
            await
                CaptureHubClient
                    .StartAsync();

            _isConnected =
                CaptureHubClient
                    .IsConnected;

            await 
                LoadScansAsync();
        }
        catch (Exception ex)
        {
            Snackbar
                .Add(
                    ex.Message,
                    Severity.Error
                );
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task HandleNewCapture()
    {
        await
            InvokeAsync(
                async () =>
                {
                    try
                    {
                        _isLoading = true;
                        StateHasChanged();

                        await
                            LoadScansAsync();

                        Snackbar
                            .Add(
                                "New scan received!",
                                Severity.Success
                            );
                    }
                    catch (Exception ex)
                    {
                        Snackbar
                            .Add(
                                ex.Message,
                                Severity.Error
                            );
                    }
                    finally
                    {
                        _isLoading = false;
                        StateHasChanged(); // Force UI update after loading
                    }
                }
            );
    }

    private async Task LoadScansAsync()
    {
        var request =
            new MyScansRequest
            {
                StartIndex = 0,
                RecordCount = 5
            };

        var response =
            await
                ApiRequestManager
                    .GetMyScansAsync(
                        request,
                        BaseCancellationToken
                    );

        _scans =
            response
                .Scans ?? [];
    }

    public async ValueTask DisposeAsync()
    {
        // Clean up SignalR subscription
        CaptureHubClient.OnNewCaptureReceived -= HandleNewCapture;

        await
            CaptureHubClient
                .DisposeAsync();
    }

}