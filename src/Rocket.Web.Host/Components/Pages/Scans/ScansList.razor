@page "/MyScans"
@using Microsoft.AspNetCore.Authorization
@using Rocket.Api.Contracts
@using Rocket.Web.Host.Api
@using Rocket.Web.Host.HubClients
@using Rocket.Web.Host.Infrastructure
@implements IAsyncDisposable
@inject IApiRequestManager ApiRequestManager
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject ICaptureHubClient CaptureHubClient
@inject IWebHostErrorHandler WebHostErrorHandler
@inherits Rocket.Web.Host.Infrastructure.CancellableComponentBase
@attribute [Authorize]

<MudText Align="Align.Center" Typo="Typo.h4">
    My Scans
    @* @if (_isConnected) *@
    @* { *@
    @*     <MudChip Color="Color.Success" Size="Size.Small" Class="ml-2"> *@
    @*         <MudIcon Icon="@Icons.Material.Filled.Wifi" Size="Size.Small"/> *@
    @*         Connected *@
    @*     </MudChip> *@
    @* } *@
</MudText>
<BottleRocketLoadingOverlay IsLoading="@_isLoading">
    <MudGrid Justify="Justify.FlexStart" Class="pa-4">
        @foreach (var scan in _scans)
        {
            <MudItem xs="12" sm="6" md="4" lg="3" xl="2">
                <MudCard Outlined>
                    <MudCardMedia
                        Image=@($"data:{scan.ContentType};base64,{scan.ThumbnailBase64}") Width="200" Height="200"/>
                    <MudCardContent>
                        <MudText Typo="Typo.body1">@(scan.DateScanned.ToString("g"))</MudText>
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton
                            Variant="Variant.Text"
                            Color="Color.Primary"
                            @onclick="@(() => NavigationManager.NavigateTo($"/MyScans/{scan.Id}"))">
                            Details
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        }
    </MudGrid>
    <MudDivider Class="my-4"/>
    <MudGrid Justify="Justify.Center">
        <MudItem>
            <MudButton
                Variant="Variant.Outlined"
                Color="Color.Primary"
                Disabled="@_noMoreRecords"
                @onclick="@(async () => await LoadScansAsync(
                              _currentIndex,
                              DefaultPageSize
                          ))">
                Load More
            </MudButton>
        </MudItem>
    </MudGrid>
</BottleRocketLoadingOverlay>

@code {
    private const int DefaultPageSize = 12;
    private bool _isLoading;
    private bool _isConnected;
    private bool _noMoreRecords = false;
    private int _currentIndex = 0;
    private IEnumerable<MyScanItem> _scans = [];

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _isLoading = true;

            // Set up SignalR listener
            CaptureHubClient.OnNewCaptureReceived += HandleNewCapture;

            // Connect to hub
            await
                CaptureHubClient
                    .StartAsync();

            _isConnected =
                CaptureHubClient
                    .IsConnected;

            await
                LoadScansAsync(
                    _currentIndex,
                    DefaultPageSize
                );
        }
        catch (Exception ex)
        {
            WebHostErrorHandler
                .HandleException(ex);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task HandleNewCapture()
    {
        await
            InvokeAsync(
                async () =>
                {
                    try
                    {
                        _isLoading = true;
                        StateHasChanged();

                        // new capture would be the most recent; get the latest record
                        await
                            LoadScansAsync(
                                0,
                                1
                            );

                        Snackbar
                            .Add(
                                "New scan received!",
                                Severity.Success
                            );
                    }
                    catch (Exception ex)
                    {
                        WebHostErrorHandler
                            .HandleException(ex);
                    }
                    finally
                    {
                        _isLoading = false;
                        StateHasChanged(); // Force UI update after loading
                    }
                }
            );
    }

    private async Task LoadScansAsync(int index, int count)
    {
        var request =
            new MyScansRequest
            {
                StartIndex = index,
                RecordCount = count
            };

        var response =
            await
                ApiRequestManager
                    .GetMyScansAsync(
                        request,
                        BaseCancellationToken
                    );

        _currentIndex +=
            (response?.Scans ?? [])
            .Count();

        _noMoreRecords = _currentIndex == (response?.TotalRecords ?? 0);

        var existingScans = new List<MyScanItem>(_scans);
        var newScans = new List<MyScanItem>(response?.Scans ?? []);

        _scans =
            existingScans
                .UnionBy(
                    newScans,
                    o => o.Id
                )
                .OrderByDescending(o => o.DateScanned);
    }

    public async ValueTask DisposeAsync()
    {
        // Clean up SignalR subscription
        CaptureHubClient.OnNewCaptureReceived -= HandleNewCapture;

        await
            CaptureHubClient
                .DisposeAsync();
    }

}