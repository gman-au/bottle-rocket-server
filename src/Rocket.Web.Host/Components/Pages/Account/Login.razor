@page "/account/login"
@using Rocket.Api.Contracts
@using Rocket.Interfaces
@inject IAuthenticationManager AuthenticationManager
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inherits Rocket.Web.Host.Infrastructure.BaseCancellableComponent

<MudPaper Class="p-4" elevation="2">
    <MudText
        Color="Color.Primary"
        GutterBottom
        Typo="Typo.h5">
        Login
    </MudText>
    <BottleRocketLoadingOverlay IsLoading="@_isLoading">
        <MudForm
            Model="@_accountLoginRequest"
            @ref="_form">
            <MudGrid>
                <MudItem xs="12">
                    <MudTextField
                        T="string"
                        Label="Username"
                        Required="true"
                        RequiredError="Please enter a user name"
                        Disabled="@(_isLoading)"
                        @bind-Value="_accountLoginRequest.Username"
                        For="@(() => _accountLoginRequest.Username)"
                        OnlyValidateIfDirty/>
                </MudItem>
                <MudItem xs="12">
                    <MudTextField
                        T="string"
                        InputType="InputType.Password"
                        Label="Password"
                        Required="true"
                        RequiredError="Password is required!"
                        Disabled="@(_isLoading)"
                        @bind-Value="_accountLoginRequest.Password"
                        For="@(() => _accountLoginRequest.Password)"
                        OnlyValidateIfDirty/>
                </MudItem>
            </MudGrid>
            <MudGrid Justify="Justify.FlexEnd">
                <MudItem>
                    <MudButton
                        Variant="Variant.Outlined"
                        Color="Color.Primary"
                        Disabled="@(_isLoading)"
                        Class="mt-4 mr"
                        OnClick="@HandleLoginAsync">
                        Login
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudForm>
    </BottleRocketLoadingOverlay>
</MudPaper>

@code {

    MudForm _form;

    private bool _isLoading;

    private readonly AccountLoginRequest _accountLoginRequest = new();
    
    [SupplyParameterFromQuery]
    public string ReturnUrl { get; set; }

    private async Task HandleLoginAsync()
    {
        await
            _form
                .Validate();

        if (_form.IsValid)
        {
            _isLoading = true;
            StateHasChanged();

            try
            {
                var success =
                    await
                        AuthenticationManager
                            .LoginAsync(
                                _accountLoginRequest.Username,
                                _accountLoginRequest.Password,
                                BaseCancellationToken
                            );

                if (success)
                {
                    await
                        Task.Delay(100);

                    NavigationManager
                        .NavigateTo(
                            !string.IsNullOrEmpty(ReturnUrl) ? ReturnUrl : "/",
                            replace: true
                            //forceLoad: true
                        );
                }
                else
                {
                    throw new Exception("Invalid username or password");
                }
            }
            catch (Exception ex)
            {
                Snackbar
                    .Add(
                        ex.Message,
                        Severity.Error
                    );
            }
            finally
            {
                _isLoading = false;
                StateHasChanged();
            }
        }
    }

}