@page "/MyConnector/Microsoft/Add"
@page "/MyConnector/Microsoft/Add/{clientId}/{tenantId}"
@using Rocket.Microsofts.Contracts
@using Rocket.Web.Client
@using Rocket.Web.Host.HubClients
@using Rocket.Web.Host.Infrastructure
@implements IAsyncDisposable
@inject IApiRequestManager ApiRequestManager
@inject IWebHostErrorHandler WebHostErrorHandler
@inject ICaptureHubClient CaptureHubClient
@inject IJSRuntime JsRuntime
@inject ISnackbar Snackbar
@inherits Rocket.Web.Host.Infrastructure.BaseSecureCancellableComponent

<BottleRocketLoadingOverlay IsLoading="@(_isAuthorizing || _isLoading)">
    @if (_initiateRequest != null)
    {
        <MudForm
            Model="@_initiateRequest"
            @ref="_form">
            <MudPaper Class="p-4" elevation="2">
                <MudText
                    Align="Align.Center"
                    Typo="Typo.h4"
                    Color="Color.Primary"
                    Class="mb-4">
                    Add a @(_isCustomConnector ? "Custom" : "Bottle-Rocket" ) Microsoft connector
                </MudText>
                <MudGrid>
                    @if (_isCustomConnector)
                    {
                        <MudItem xs="12">
                            <MudText
                                Color="Color.Secondary"
                                Typo="Typo.h5">
                                Step 1: Create a registered Entra / Microsoft application
                            </MudText>
                            <MudText>
                                <ul>
                                    <li>
                                        <MudLink
                                            Target="_blank"
                                            Href="https://gman-au.github.io/bottle-rocket-documentation/docs/docs-general/workflow-integrations/microsoft#option-2--adding-a-custom-microsoft-application">
                                            Follow the instructions to set up a Microsoft app registration.
                                        </MudLink>
                                    </li>
                                    <li>Ensure that the correct permissions / scopes are set.</li>
                                    <li>When completed, you should receive an <b>Client ID</b> and <b>Tenant ID</b>, which needs to be entered
                                        below.
                                    </li>
                                </ul>
                            </MudText>
                        </MudItem>
                        <MudItem sm="12" lg="6">
                            <MudTextField
                                T="string"
                                Required="true"
                                Label="Client ID"
                                Disabled="_isAuthorizing"
                                HelperText="Enter the Client ID"
                                @bind-Value="_initiateRequest.ClientId"
                                For="@(() => _initiateRequest.ClientId)"
                                RequiredError="Client ID is required"/>
                        </MudItem>
                        <MudItem sm="12" lg="6">
                            <MudTextField
                                T="string"
                                Required="true"
                                Label="Tenant ID"
                                Disabled="_isAuthorizing"
                                HelperText="Enter the Tenant ID"
                                @bind-Value="_initiateRequest.TenantId"
                                For="@(() => _initiateRequest.TenantId)"
                                RequiredError="Tenant ID is required"/>
                        </MudItem>
                        <MudDivider Class="my-2"/>
                    }
                    <MudItem xs="12">
                        <MudText
                            Color="Color.Secondary"
                            Typo="Typo.h5">
                            Step @(_isCustomConnector ? 2 : 1): Get an authorization code from Microsoft
                        </MudText>
                        <MudText>
                            <ul>
                                <li>
                                    Click on the <b>Authorize button</b> below to receive a code to
                                    enter into Microsoft's app authorization page.
                                </li>
                            </ul>
                        </MudText>
                    </MudItem>
                    <MudItem sm="12" lg="6">
                        <MudButton
                            Variant="Variant.Outlined"
                            Color="Color.Secondary"
                            Disabled="!(_isAuthorizing || !_form.IsValid) && _isCustomConnector"
                            OnClick="@BeginAuthorizeAsync">
                            Get an authorization code
                        </MudButton>
                    </MudItem>
                    <MudDivider Class="my-2"/>
                    <MudItem xs="12">
                        <MudText
                            Color="Color.Secondary"
                            Typo="Typo.h5">
                            Step @(_isCustomConnector ? 3 : 2): Complete the authorization process via Microsoft authentication
                        </MudText>
                    </MudItem>
                    <MudItem xs="12">
                        <MudContainer Class="general-centered">
                            <MudText
                                Color="Color.Info"
                                Typo="Typo.h2"
                                Class="code-text">
                                @_userCode
                            </MudText>
                        </MudContainer>
                    </MudItem>
                    <MudItem xs="12">
                        <MudText>
                            <ul>
                                <li>
                                    Copy this code.
                                </li>
                                <li>
                                    Click on the <b>Complete authorization</b> button below to open a Microsoft login page,
                                    where you can enter the code above and complete the authorization.
                                </li>
                            </ul>
                        </MudText>
                    </MudItem>
                </MudGrid>
                <MudGrid Class="align-start mt-2" Justify="Justify.FlexEnd">
                    <MudItem>
                        <GoBackButton/>
                    </MudItem>
                    <MudItem>
                        <MudButton
                            Variant="Variant.Outlined"
                            Color="Color.Success"
                            Disabled="@(_isAuthorizing || string.IsNullOrEmpty(_verificationUrl))"
                            OnClick="@CompleteAuthorizeAsync">
                            Complete authorization
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudForm>
    }
</BottleRocketLoadingOverlay>

@code {

    MudForm _form;

    private bool _isLoading;
    private bool _isCustomConnector = false;
    private bool _isAuthorizing = false;
    private MicrosoftAuthInitiateRequest _initiateRequest;

    private string _userCode = null;
    private string _verificationUrl = null;

    [Parameter]
    public string Id { get; set; }
    
    [Parameter]
    public string ClientId { get; set; }
    
    [Parameter]
    public string TenantId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await
                base
                    .OnInitializedAsync();

            _isLoading = true;
            StateHasChanged();
            
            _isCustomConnector = string.IsNullOrEmpty(ClientId) || string.IsNullOrEmpty(TenantId);

            _initiateRequest = new MicrosoftAuthInitiateRequest();

            if (!_isCustomConnector)
            {
                _initiateRequest.ClientId = ClientId;
                _initiateRequest.TenantId = TenantId;
            }
            
            // Set up SignalR listener
            CaptureHubClient.OnNewConnectorUpdateReceived += HandleNewConnectorUpdateAsync;
            
            // Connect to hub
            await
                CaptureHubClient
                    .StartAsync();
        }
        catch (Exception ex)
        {
            WebHostErrorHandler
                .HandleException(ex);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task BeginAuthorizeAsync()
    {
        await
            _form
                .Validate();

        if (_form.IsValid)
        {
            _isLoading = true;
            StateHasChanged();

            try
            {
                var clientId = _initiateRequest.ClientId;
                var tenantId = _initiateRequest.TenantId;

                var response =
                    await
                        ApiRequestManager
                            .InitiateMicrosoftConnectorAuthAsync(
                                new MicrosoftAuthInitiateRequest
                                {
                                    ClientId = clientId,
                                    TenantId = tenantId
                                },
                                BaseCancellationToken
                            );

                _verificationUrl = response?.Result?.VerificationUrl;
                _userCode = response?.Result?.UserCode;

                if (string.IsNullOrEmpty(_verificationUrl))
                    throw new Exception("There was a connection error.");

                if (string.IsNullOrEmpty(_userCode))
                    throw new Exception("There was a connection error.");
            }
            catch (Exception ex)
            {
                WebHostErrorHandler
                    .HandleException(ex);
            }
            finally
            {
                _isLoading = false;
                StateHasChanged();
            }
        }
    }

    private async Task CompleteAuthorizeAsync()
    {
        _isAuthorizing = true;
        StateHasChanged();

        await
            JsRuntime
                .InvokeVoidAsync(
                    "eval",
                    $"window.open('{_verificationUrl}', '_blank')"
                );
    }
    
    private async Task HandleNewConnectorUpdateAsync(bool success)
    {
        if (success)
        {
            Snackbar
                .Add(
                    "The connection has been added.",
                    Severity.Success
                );

            NavigationManager
                .NavigateTo("/MyConnectors");
        }
        else
        {
            Snackbar
                .Add(
                    "There was an error adding the connection.",
                    Severity.Error
                );
            
            _isLoading = false;
            StateHasChanged();
        }
    }

    public async ValueTask DisposeAsync()
    {
        // Clean up SignalR subscription
        CaptureHubClient.OnNewConnectorUpdateReceived -= HandleNewConnectorUpdateAsync;

        await
            CaptureHubClient
                .DisposeAsync();
    }
    
}