@page "/MyExecution/{id}"
@using Rocket.Api.Contracts.Executions
@using Rocket.Domain.Utils
@using Rocket.Interfaces
@using Rocket.Web.Client
@using Rocket.Web.Host.HubClients
@using Rocket.Web.Host.Infrastructure
@inject IJSRuntime JsRuntime
@inject ISnackbar Snackbar
@inject ICaptureHubClient CaptureHubClient
@inject IApiRequestManager ApiRequestManager
@inject IWebHostErrorHandler WebHostErrorHandler
@inject IExecutionMermaidConverter ExecutionMermaidConverter
@inherits Rocket.Web.Host.Infrastructure.BaseSecureCancellableComponent

<BottleRocketLoadingOverlay IsLoading="@_isLoading">
    @if (_currentModel != null)
    {
        <MudPaper Class="p-4" elevation="2">
            <MudGrid Class="pa-8" Justify="Justify.SpaceEvenly">
                <MudItem sm="12" md="6">
                    <MudStack
                        Style="height:100%;"
                        Justify="Justify.SpaceBetween"
                        StretchItems="StretchItems.Middle"
                        AlignItems="AlignItems.Start">
                        <MudText
                            Align="Align.Center"
                            Typo="Typo.h4"
                            Color="Color.Primary"
                            Class="mb-4">
                            Workflow Run Details
                        </MudText>
                        <div style="text-align: center; width:100%">
                            <MudSimpleTable
                                Bordered
                                Dense>
                                <tbody>
                                <ComplexTableRowPair Title="Workflow Name">
                                    <MudLink Href=@($"/MyWorkflow/{_currentModel.WorkflowId}")>
                                        <MudText
                                            Class="code-text"
                                            Typo="Typo.body1"
                                            Align="Align.Left"
                                            GutterBottom="true">
                                            @_currentModel.Name
                                        </MudText>
                                    </MudLink>
                                </ComplexTableRowPair>
                                <SimpleTableRowPair
                                    Title="Run Status"
                                    Value=@(DomainConstants.ExecutionStatusTypes.ContainsKey((int)_currentModel.ExecutionStatus) ? DomainConstants.ExecutionStatusTypes[(int)_currentModel.ExecutionStatus] : "Unknown")
                                />
                                <SimpleTableRowPair Title="Run Date"
                                                    Value=@_currentModel?.RunDate?.ToString("g")/>
                                <ComplexTableRowPair Title="Image">
                                    <MudLink Href=@($"/MyScans/{_currentModel.ScanId}")>
                                        <MudImage
                                            Class="mud-border-secondary border rounded"
                                            Src=@($"data:{_currentModel.ContentType};base64,{_currentModel.ThumbnailBase64}") Width="200"
                                            Height="200"/>

                                    </MudLink>
                                </ComplexTableRowPair>
                                </tbody>
                            </MudSimpleTable>
                        </div>
                        <MudGrid Class="align-start" Justify="Justify.FlexEnd">
                            <MudItem>
                                <GoBackButton/>
                            </MudItem>
                        </MudGrid>
                    </MudStack>
                </MudItem>
                <MudItem sm="12" md="6">
                    <!-- form -->
                    <MudPaper Elevation="4" Class="p-4 mermaid-paper">
                        <pre class="mermaid">
                    @MermaidText
                </pre>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudPaper>
    }
</BottleRocketLoadingOverlay>

@code {

    MudForm _form;

    private bool _disposed = false;
    private bool _isLoading;
    private bool _isConnected;
    private ExecutionSummary _currentModel = null;

    [Parameter]
    public string Id { get; set; }

    private string MermaidText { get; set; }

    private DotNetObjectReference<ExecutionDetails> _dotNetRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef =
                DotNetObjectReference
                    .Create(this);

            await
                JsRuntime
                    .InvokeVoidAsync(
                        "storeDotNetRef",
                        _dotNetRef
                    );

            await
                Task
                    .Delay(100);

            await
                JsRuntime
                    .InvokeVoidAsync("mermaid.run");
        }
    }

    [JSInvokable]
    public void NavigateToRoute(string route)
    {
        if (_disposed)
            return;

        NavigationManager
            .NavigateTo(route);
    }

    public override void Dispose()
    {
        if (!_disposed)
        {
            _disposed = true;

            _dotNetRef?
                .Dispose();

            base
                .Dispose();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await
                base
                    .OnInitializedAsync();

            _isLoading = true;

            // Set up SignalR listener
            CaptureHubClient.OnNewExecutionUpdateReceived += HandleExecutionUpdate;

            // Connect to hub
            await
                CaptureHubClient
                    .StartAsync();

            _isConnected =
                CaptureHubClient
                    .IsConnected;

            await
                ReloadExecutionDetailsAsync();
        }
        catch (Exception ex)
        {
            WebHostErrorHandler
                .HandleException(ex);
        }
        finally
        {
            _isLoading = false;
        }
    }
    
    private async Task ReloadExecutionDetailsAsync()
    {
        _currentModel =
            await
                ApiRequestManager
                    .GetExecutionByIdAsync(
                        Id,
                        BaseCancellationToken
                    );

        MermaidText =
            ExecutionMermaidConverter
                .Convert(_currentModel);
    }

    private async Task HandleExecutionUpdate()
    {
        await
            InvokeAsync(
                async () =>
                {
                    try
                    {
                        _isLoading = true;
                        StateHasChanged();

                        // new capture would be the most recent; get the latest record
                        await
                            ReloadExecutionDetailsAsync();

                        Snackbar
                            .Add(
                                "New update received!",
                                Severity.Success
                            );
                    }
                    catch (Exception ex)
                    {
                        WebHostErrorHandler
                            .HandleException(ex);
                    }
                    finally
                    {
                        _isLoading = false;
                        StateHasChanged(); // Force UI update after loading
                    }
                }
            );
    }

    public async ValueTask DisposeAsync()
    {
        // Clean up SignalR subscription
        CaptureHubClient.OnNewExecutionUpdateReceived -= HandleExecutionUpdate;

        await
            CaptureHubClient
                .DisposeAsync();
    }

}